---
# yamllint disable rule:line-length
generators:
  go: barney.ci/golang%generator

images:

  internal/alma-9.1-bootstrap:
    units:
      - image: barney.ci/docker%image/docker.corp.arista.io/almalinuxorg/9-minimal//9.1-20230222
      - sources: []
        build: |
          mkdir -p /dest/etc
          touch /dest/etc/resolv.conf
    finalizers:
      - |
          export DNF_HOST="https://artifactory.infra.corp.arista.io/artifactory"
          export DNF_ARCH="$(arch)"
          export DNF_DISTRO_REPO="alma-linux/9.1"
          export DNF_EPEL_REPO="centos-9-epel"
          echo '#!/bin/sh
          microdnf --assumeyes --installroot=/dest --noplugins --config=/etc/dnf/dnf.conf \
                   --setopt=cachedir=/var/cache/microdnf --setopt=reposdir=/etc/yum.repos.d \
                   --setopt=varsdir=/etc/dnf --releasever=9.1 install "$@"
          ' > /usr/bin/install-rpms
          chmod 755 /usr/bin/install-rpms
          rm -rf /etc/yum.repos.d
          mkdir -p /etc/yum.repos.d
          echo "[epel]
          baseurl=${DNF_HOST}/${DNF_EPEL_REPO}/${DNF_ARCH}/
          enabled=1
          gpgcheck=0
          " > /etc/yum.repos.d/epel.repo
          echo "[BaseOS]
          baseurl=${DNF_HOST}/${DNF_DISTRO_REPO}/BaseOS/${DNF_ARCH}/os/
          enabled=1
          " > /etc/yum.repos.d/BaseOS.repo
          echo "[AppStream]
          baseurl=${DNF_HOST}/${DNF_DISTRO_REPO}/AppStream/${DNF_ARCH}/os/
          enabled=1
          " > /etc/yum.repos.d/AppStream.repo

    entry:
      share-net: true
      mounts:
        - source: /etc/resolv.conf
          target: /etc/resolv.conf
          options: ro,bind
      mutables:
        - /var/cache
        - /var/lib/dnf

  base-image:
    units:
      - floor: .%internal/alma-9.1-bootstrap
        sources: []
        build: install-rpms coreutils rpm rpm-build rpmdevtools automake mock

  go-binaries:
    description: |
      This image is a copy of .%go/static, but with /usr/bin
      permissions changed to 0555, so that it can combine properly
      with redhat-style images.
    units:
      - mappings:
          /src/static: .%go/static
        build: |
          mkdir -p /dest/usr
          cp -a /src/static/usr/bin /dest/usr/bin
          chmod 555 /dest/usr/bin

  eext:
    units:
      - image: .%base-image
      - image: .%go-binaries

  eext-testfloor:
    units:
      - image: .%go/modules
      - build: |
          mkdir -p /dest/var/cache/go
          mkdir -p /dest/var/ext
      - floor: .%internal/alma-9.1-bootstrap
        sources: []
        build: install-rpms coreutils rpm rpm-build rpmdevtools automake mock golang
    entry:
      env:
        GOCACHE: /tmp/gocache
        GOMODCACHE: /go/pkg/mod
      mutables:
        - /var/cache/go
        - /var/ext

  test/eext:
    units:
      - floor: .%eext-testfloor
        build: |
          go test code.arista.io/eos/tools/eext/...
          go test code.arista.io/eos/tools/eext/... -tags privileged

  bus:
    units:
      - image: barney.ci/barney%bus
      - image: barney.ci/alpine%pkg/vim
